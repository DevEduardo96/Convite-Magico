document.addEventListener("DOMContentLoaded", () => {
  // --- L√ìGICA DA INTRO (ENVELOPE E BAL√ïES) ---
  const envelope = document.getElementById("envelope");
  const introOverlay = document.getElementById("intro-overlay");
  const gameContainer = document.getElementById("game-container");
  let gameStarted = false;

  createBalloons();

  envelope.addEventListener("click", () => {
    if (gameStarted) return;
    gameStarted = true;

    envelope.classList.add("open");

    setTimeout(() => {
      introOverlay.style.opacity = "0";
      setTimeout(() => {
        introOverlay.style.display = "none";
        document.querySelectorAll(".balloon").forEach((b) => b.remove());
        gameContainer.classList.remove("hidden");
        initGame();
      }, 800);
    }, 1500);
  });

  function createBalloons() {
    const colors = ["#ff69b4", "#9c27b0", "#ffc107", "#03a9f4", "#4caf50"];
    const numBalloons = 15;
    for (let i = 0; i < numBalloons; i++) {
      const balloon = document.createElement("div");
      balloon.classList.add("balloon");
      const size = Math.floor(Math.random() * 30) + 40;
      balloon.style.setProperty("--size", `${size}px`);
      balloon.style.setProperty(
        "--color",
        colors[Math.floor(Math.random() * colors.length)],
      );
      balloon.style.left = `${Math.random() * 90}vw`;
      balloon.style.setProperty(
        "--duration",
        `${Math.floor(Math.random() * 10) + 8}s`,
      );
      balloon.style.setProperty("--delay", `${Math.random() * 5}s`);
      introOverlay.appendChild(balloon);
    }
  }

  // --- L√ìGICA DO JOGO (TABULEIRO) ---
  const boardEl = document.getElementById("board");
  const princess = document.createElement("div");
  princess.classList.add("princess");
  princess.textContent = "üë∏";

  // Aumentado para 20 quadros
  const totalTiles = 20;
  const obstacles = {
    5: {
      question: "Qual o desenho favorito dela?",
      options: ["Blippi", "Maria Clara e JP", "Peppa Pig"],
      correct: 1,
    },
    10: {
      question: "Quantos anos ela vai fazer?",
      options: ["2", "3", "4"],
      correct: 1, // Corrigido para √≠ndice 1 (se a resposta for 3 anos e a lista for [2,3,4])
    },
    15: {
      question: "Qual a comida que a princesa mais gosta?",
      options: ["Pizza", "Frutinhas", "Batata Frita"],
      correct: 1,
    },
  };

  let currentPosition = 0;
  let isMoving = false;

  function initGame() {
    boardEl.innerHTML = ""; // Limpa tabuleiro
    for (let i = 0; i < totalTiles; i++) {
      const tile = document.createElement("div");
      tile.classList.add("tile");
      tile.dataset.index = i;
      if (i === 0) {
        tile.classList.add("start");
        tile.textContent = "In√≠cio";
      } else if (i === totalTiles - 1) {
        tile.classList.add("castle");
        tile.textContent = "üè∞";
      } else if (obstacles[i]) {
        tile.classList.add("question");
        tile.textContent = "?";
      } else {
        tile.textContent = i;
      }
      boardEl.appendChild(tile);
    }
    movePrincessTo(0);
  }

  function movePrincessTo(index) {
    const targetTile = document.querySelector(`.tile[data-index='${index}']`);
    if (targetTile) targetTile.appendChild(princess);
  }

  document.getElementById("roll-btn").addEventListener("click", async () => {
    if (isMoving) return;
    isMoving = true;

    const btn = document.getElementById("roll-btn");
    const diceDisplay = document.getElementById("dice-display");
    btn.disabled = true;

    const diceFaces = ["‚öÄ", "‚öÅ", "‚öÇ", "‚öÉ", "‚öÑ", "‚öÖ"];

    for (let i = 0; i < 12; i++) {
      let tempRoll = Math.floor(Math.random() * 6);
      diceDisplay.textContent = diceFaces[tempRoll];
      await new Promise((r) => setTimeout(r, 70));
    }

    let roll = Math.floor(Math.random() * 6) + 1;
    diceDisplay.textContent = diceFaces[roll - 1];

    await moveStepByStep(roll);

    btn.disabled = false;
    isMoving = false;
  });

  async function moveStepByStep(steps) {
    for (let i = 0; i < steps; i++) {
      if (currentPosition < totalTiles - 1) {
        currentPosition++;
        movePrincessTo(currentPosition);

        // Se pisar em um obst√°culo durante o percurso, para imediatamente para responder
        if (obstacles[currentPosition]) {
          await new Promise((r) => setTimeout(r, 400));
          break;
        }
        await new Promise((r) => setTimeout(r, 400));
      }
    }
    checkTile();
  }

  function checkTile() {
    if (currentPosition === totalTiles - 1) {
      setTimeout(() => {
        document.getElementById("win-modal").classList.remove("hidden");
        startSlideshow();
      }, 500);
      return;
    }

    if (obstacles[currentPosition]) {
      showQuestion(obstacles[currentPosition]);
    }
  }

  // --- L√ìGICA DO SLIDESHOW ---
  function startSlideshow() {
    const slides = document.querySelectorAll(".slide");
    if (slides.length === 0) return;
    let currentSlideIdx = 0;

    setInterval(() => {
      slides[currentSlideIdx].classList.remove("active-slide");
      currentSlideIdx = (currentSlideIdx + 1) % slides.length;
      slides[currentSlideIdx].classList.add("active-slide");
    }, 3000);
  }

  // --- L√ìGICA DAS PERGUNTAS ---
  function showQuestion(obstacleData) {
    const modal = document.getElementById("question-modal");
    const ansContainer = document.getElementById("answers-container");
    document.getElementById("question-text").textContent =
      obstacleData.question;
    document.getElementById("feedback-msg").textContent = "";
    ansContainer.innerHTML = "";
    modal.classList.remove("hidden");

    obstacleData.options.forEach((opt, index) => {
      const btn = document.createElement("button");
      btn.classList.add("answer-btn");
      btn.textContent = opt;
      btn.onclick = () => {
        if (index === obstacleData.correct) {
          modal.classList.add("hidden");
          // Avan√ßa uma casa extra de b√¥nus por acertar
          if (currentPosition < totalTiles - 1) {
            currentPosition++;
            movePrincessTo(currentPosition);
            // Verifica se essa nova casa √© o castelo
            if (currentPosition === totalTiles - 1) checkTile();
          }
        } else {
          document.getElementById("feedback-msg").textContent =
            "Quase l√°! Tente de novo na pr√≥xima rodada!";
          document.getElementById("feedback-msg").style.color = "#e91e63";
          setTimeout(() => modal.classList.add("hidden"), 1500);
        }
      };
      ansContainer.appendChild(btn);
    });
  }
});
